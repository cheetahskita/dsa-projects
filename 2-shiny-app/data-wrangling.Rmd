---
title: "Data Wrangling"
output: html_notebook
---

# SETUP
```{r}
library(tidyverse)

setwd('C:/Users/moth1/OneDrive/Documents/dsa-projects/2-shiny-app')
```

# LOAD FILES
```{r warning=FALSE, include=FALSE}
csv_filenames = list.files("./data", pattern = "*.csv")
csv_filepaths = paste('./data', csv_filenames, sep = '/')

data_length = length(csv_filepaths)
dflist = rep(list(1), data_length)

years = c(2014, 2016, 2017, 2018, 2019)
for (i in 1:data_length){
  df = read.csv(csv_filepaths[i])
  year = data.frame(year = rep(years[i], dim(df)[1]))
  dflist[[i]] = bind_cols(year, df)
}
backup = dflist
```

# DATA WRANGLING

## Data Preparation

### Cleaning Variable Names (Questions)
```{r}
dflist = backup
clean.qs = function(df){
  qs = names(df)
  qs = lapply(qs, gsub, pattern='\\.strong\\.', replacement='.')
  qs = lapply(qs, gsub, pattern='\\.em\\.', replacement='.')
  qs = lapply(qs, gsub, pattern='\\._\\.', replacement='.')
  qs = lapply(qs, gsub, pattern='^X.', replacement='')
  qs = lapply(qs, gsub, pattern='\\.\\.\\.\\.', replacement='.')
  qs = lapply(qs, gsub, pattern='\\.\\.\\.', replacement='.')
  qs = lapply(qs, gsub, pattern='\\.\\.', replacement='.')
  names(df) = qs
  return(df)
}
dflist = lapply(dflist, clean.qs)
```

### Manual Pre-processing
```{r}
colnames(dflist[[1]])[3] <- "what.is.your.age."
colnames(dflist[[1]])[5] <- "what.country.do.you.work.in."
colnames(dflist[[1]])[10] <- "if.you.have.a.mental.health.issue.do.you.feel.that.it.interferes.with.your.work.when.NOT.being.treated.effectively."
qs = lapply(dflist, names)
```

### Functions to Verify Keywords/Questions
```{r}
verify = function(keyword) {
  cat(c("\n","\"", keyword, "\"", "\n"))
  cat("-----------------------\n")
  q.list <- grep(keyword, qs, ignore.case=TRUE)
  q.locs <- lapply(qs, grep, pattern=keyword, ignore.case=TRUE)  
  if (length(q.list)!=5){
    warning("Warning! Keyword not present in all years.")
    
  } else if (sum(unlist(lapply(q.locs, length)))>5){
    warning("Warning! Keyword present more than once in a year.")
    
  } else{
    warning("Keyword is a match!")
  }
  warning(" These are the matching questions:\n")
  print.qs(q.locs)
}
print.qs = function(q.locs){
  for (i in 1:5){
    for (j in 1:length(q.locs[[i]]))
    cat( c('List ',i,', ',
           'col ', q.locs[[i]][j], ': ',
           pluck(qs, i, q.locs[[i]][j]),
           '\n'), sep = "")
  }
}
```

### Manual Verification of Each Keyword/Questions
```{r}
verify("year")
verify("what.is.your.age.")
verify("gender")
verify("what.country.do.you.work.in.")
verify("family.history.of.mental.illness.")
verify("sought.treatment.")
verify("interferes.with.your.work.when.not.")
verify("how.many.employees.")
verify("is.your.employer.primarily.a.tech.company.")
verify("employer.provide.mental.health.benefits.")
verify("do.you.know.the.options.for.mental.health.")
```

## Data Loading

### Helpful Function to Find Variables Indixces
```{r}
keyword.locs = function(keyword, df) {
  qs = names(df)
  key.loc = grep(keyword, qs, ignore.case=TRUE)
  return(key.loc)
}
```

### Manually Define Keywords
```{r}
verified.qs = list("year",
                   "what.is.your.age.",
                   "gender",
                   "what.country.do.you.work.in.",
                   "family.history.of.mental.illness.",
                   "sought.treatment.",
                   "interferes.with.your.work.when.not.",
                   "how.many.employees.",
                   "is.your.employer.primarily.a.tech.company.",
                   "employer.provide.mental.health.benefits.",
                   "do.you.know.the.options.for.mental.health.")
```

### Build Data Frame from Keywords
```{r}
df.tot = data.frame()

for (i in 1:data_length){   #for each data frame
  
  df = dflist[[i]]
  new.table = data.frame()
  
  for (j in 1:length(verified.qs)){   #for each question
    
    #unpack the question
    q = verified.qs[j]
    
    #find index in current table
    q.loc = keyword.locs(q, df)
    
    #extract question to new data frame
    new.col = select(df, q.loc)
    new.col[] = lapply(new.col, as.character)
    names(new.col) = tolower(q)
    
    #special case for j = 1
    if (j==1){
      new.table = new.col
    } else{
      new.table = bind_cols(new.table, new.col)
    }
  }
  #append to main data frame
  df.tot = bind_rows(df.tot, new.table)
}
df.tot = as.data.frame(sapply(df.tot, tolower))
backup2 = df.tot
```

### Data Cleaning (Elements)
```{r}
# RESERVED FOR CLEANING UP COLUMNS

df.tot$year = as.factor(df.tot$year)
df.tot = df.tot %>% 
  rename(age = what.is.your.age.)

df.tot$age[(df.tot$age < 18) | (df.tot$age > 75)] = NA

df.tot = df.tot %>% 
  replace_na(list(age = median(df.tot$age, na.rm=TRUE)))

# TO DO LIST:

# filter gender into 5 categories
# group countries as continents? downsample to US/UK?
# filter sought.treatment, interferes.with, employer.tech, employer.provide, know.options
# # from 0/1, yes/no, true/false into only yes/no as.factor
# group number of employees and order as.factor
```


# DATA VISUALIZATION

## EDA Bar Charts
```{r}
for (i in 1:length(verified.qs)){
  q = verified.qs[[i]]
  barplot(table(df.tot[q]), main = q)
}
```

# OUTPUT FILES
```{r}
write_csv(df.tot, "server.csv")
```

